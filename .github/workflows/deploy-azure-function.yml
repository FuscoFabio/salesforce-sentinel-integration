name: Configure Azure Function App Settings

on:
  push:
    branches:
      - main
      - feature/salesforce-polling-python-function
    paths:
      - 'azure-function/salesforce-sentinel-polling/**'
      - '.github/workflows/deploy-azure-function.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to configure'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_FUNCTIONAPP_NAME: ${{ secrets.AZURE_FUNCTIONAPP_NAME }}

jobs:
  configure-settings:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check if Azure credentials are configured
        id: check_creds
        run: |
          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "⚠️  Warning: AZURE_CREDENTIALS secret is not configured"
            echo ""
            echo "This workflow will be skipped. If you want to use this workflow to configure"
            echo "Application Settings automatically, please configure the AZURE_CREDENTIALS secret:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: AZURE_CREDENTIALS"
            echo "4. Value: JSON output from 'az ad sp create-for-rbac --sdk-auth'"
            echo ""
            echo "See DEPLOYMENT_CENTER_SETUP.md and .github/TROUBLESHOOTING.md for detailed instructions"
            echo ""
            echo "Note: If you're using Azure Deployment Center, this workflow is optional."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "✅ AZURE_CREDENTIALS secret is configured"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Verify Azure credentials
        if: steps.check_creds.outputs.skip != 'true'
        run: |
          # Verifica che il JSON sia valido
          CREDS="${{ secrets.AZURE_CREDENTIALS }}"
          
          # Rimuovi spazi iniziali/finali e newline extra
          CREDS=$(echo "$CREDS" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Prova a validare il JSON e mostra l'errore specifico
          JSON_ERROR=$(echo "$CREDS" | python3 -m json.tool 2>&1)
          if [ $? -ne 0 ]; then
            echo "❌ Error: AZURE_CREDENTIALS is not valid JSON"
            echo ""
            echo "JSON validation error:"
            echo "$JSON_ERROR" | head -5
            echo ""
            echo "First 200 characters of the secret (for debugging):"
            echo "$CREDS" | head -c 200
            echo ""
            echo ""
            echo "Please ensure the secret contains valid JSON format:"
            echo "1. Copy the ENTIRE output from: az ad sp create-for-rbac --sdk-auth"
            echo "2. Make sure to include the opening { and closing }"
            echo "3. Do not add extra quotes or formatting"
            echo ""
            echo "Expected format:"
            echo '{'
            echo '  "clientId": "xxxx-xxxx-xxxx-xxxx",'
            echo '  "clientSecret": "yyyy-yyyy-yyyy-yyyy",'
            echo '  "tenantId": "zzzz-zzzz-zzzz-zzzz",'
            echo '  "subscriptionId": "aaaa-aaaa-aaaa-aaaa"'
            echo '}'
            echo ""
            echo "To generate the correct JSON, run:"
            echo "az login"
            echo "az ad sp create-for-rbac --name 'github-actions-salesforce-sentinel' \\"
            echo "  --role contributor \\"
            echo "  --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} \\"
            echo "  --sdk-auth"
            echo ""
            echo "For detailed troubleshooting, see: .github/TROUBLESHOOTING.md"
            exit 1
          fi
          
          # Salva il JSON pulito per uso successivo
          CREDS=$(echo "$CREDS" | python3 -m json.tool)
          
          # Mostra i campi presenti nel JSON (senza valori) per debug
          echo "Checking JSON structure..."
          echo "Fields found in JSON:"
          echo "$CREDS" | grep -o '"[^"]*"' | head -10 || echo "Could not parse JSON structure"
          echo ""
          
          # Verifica campi necessari (accetta sia camelCase che snake_case)
          HAS_CLIENT_ID=false
          HAS_CLIENT_SECRET=false
          HAS_TENANT_ID=false
          HAS_SUBSCRIPTION_ID=false
          
          if echo "$CREDS" | grep -qiE '"(clientId|client_id)"'; then
            HAS_CLIENT_ID=true
          fi
          if echo "$CREDS" | grep -qiE '"(clientSecret|client_secret)"'; then
            HAS_CLIENT_SECRET=true
          fi
          if echo "$CREDS" | grep -qiE '"(tenantId|tenant_id)"'; then
            HAS_TENANT_ID=true
          fi
          if echo "$CREDS" | grep -qiE '"(subscriptionId|subscription_id)"'; then
            HAS_SUBSCRIPTION_ID=true
          fi
          
          # Report errori
          ERRORS=0
          if [ "$HAS_CLIENT_ID" = false ]; then
            echo "❌ Error: JSON is missing 'clientId' or 'client_id' field"
            ERRORS=$((ERRORS + 1))
          fi
          if [ "$HAS_CLIENT_SECRET" = false ]; then
            echo "❌ Error: JSON is missing 'clientSecret' or 'client_secret' field"
            ERRORS=$((ERRORS + 1))
          fi
          if [ "$HAS_TENANT_ID" = false ]; then
            echo "❌ Error: JSON is missing 'tenantId' or 'tenant_id' field"
            ERRORS=$((ERRORS + 1))
          fi
          if [ "$HAS_SUBSCRIPTION_ID" = false ]; then
            echo "❌ Error: JSON is missing 'subscriptionId' or 'subscription_id' field"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "The JSON should have this structure:"
            echo '{'
            echo '  "clientId": "...",'
            echo '  "clientSecret": "...",'
            echo '  "tenantId": "...",'
            echo '  "subscriptionId": "..."'
            echo '}'
            echo ""
            echo "To generate the correct JSON, run:"
            echo "az ad sp create-for-rbac --name 'github-actions-salesforce-sentinel' \\"
            echo "  --role contributor \\"
            echo "  --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} \\"
            echo "  --sdk-auth"
            exit 1
          fi
          
          echo "✅ AZURE_CREDENTIALS secret is configured and valid"
      
      - name: Login to Azure
        if: steps.check_creds.outputs.skip != 'true'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Configure Deployment Center path
        if: steps.check_creds.outputs.skip != 'true'
        run: |
          echo "Configuring Deployment Center to use correct directory..."
          # Configura la directory di lavoro per il Deployment Center
          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              "SCM_REPOSITORY_PATH=azure-function/salesforce-sentinel-polling" \
              "SCM_DO_BUILD_DURING_DEPLOYMENT=true" \
              "ENABLE_ORYX_BUILD=true" || echo "Warning: Could not set deployment path settings"
          echo "✅ Deployment Center path configured"
      
      - name: Configure Application Settings
        if: steps.check_creds.outputs.skip != 'true'
        id: configure
        env:
          LOG_TYPE: ${{ secrets.LOG_ANALYTICS_LOG_TYPE || 'Salesforce_CL' }}
        run: |
          echo "Configuring Application Settings for: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --settings \
              "Salesforce__ConsumerKey=${{ secrets.SALESFORCE_CONSUMER_KEY }}" \
              "Salesforce__ConsumerSecret=${{ secrets.SALESFORCE_CONSUMER_SECRET }}" \
              "Salesforce__Username=${{ secrets.SALESFORCE_USERNAME }}" \
              "Salesforce__Password=${{ secrets.SALESFORCE_PASSWORD }}" \
              "Salesforce__SecurityToken=${{ secrets.SALESFORCE_SECURITY_TOKEN }}" \
              "LogAnalytics__WorkspaceId=${{ secrets.LOG_ANALYTICS_WORKSPACE_ID }}" \
              "LogAnalytics__WorkspaceKey=${{ secrets.LOG_ANALYTICS_WORKSPACE_KEY }}" \
              "LogAnalytics__LogType=${{ env.LOG_TYPE }}"
          echo "settings_configured=true" >> $GITHUB_OUTPUT
      
      - name: Workflow skipped notice
        if: steps.check_creds.outputs.skip == 'true'
        run: |
          echo "ℹ️  This workflow was skipped because AZURE_CREDENTIALS is not configured."
          echo "   If you're using Azure Deployment Center, this is expected and you can ignore this message."
          echo "   The deployment will proceed via Azure Deployment Center."
      
      - name: Configuration summary
        if: always() && steps.check_creds.outputs.skip != 'true'
        run: |
          if [ "${{ steps.configure.outcome }}" == "success" ]; then
            echo "✅ Application Settings configured successfully"
            echo "Note: Code deployment is handled by Azure Deployment Center"
          else
            echo "❌ Failed to configure Application Settings"
            exit 1
          fi

